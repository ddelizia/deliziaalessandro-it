---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { Badge } from "../../components/ui/badge";
import { Separator } from "../../components/ui/separator";
import { buttonVariants } from "../../components/ui/button";
import { getCollection, type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import { cn } from "@/lib/utils";

export async function getStaticPaths() {
    const posts = await getCollection("blog");
    // Sort by Date descending
    posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

    return posts.map((post, index) => ({
        params: { slug: post.slug },
        props: {
            post,
            // Previous in list is newer (index - 1), Next in list is older (index + 1)
            // But visually "Previous" usually means "Older" post and "Next" means "Newer" post?
            // Let's stick to list order: Previous item in array, Next item in array.
            // If sorted descending: index-1 is newer, index+1 is older.
            // Let's swap labels in UI or swap logic here.
            // Logic: prevPost = newer, nextPost = older
            nextPost: index > 0 ? posts[index - 1] : null,
            prevPost: index < posts.length - 1 ? posts[index + 1] : null,
        },
    }));
}

// type Props = CollectionEntry<"blog">;

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();

const formatDate = (date: Date) => {
    return date.toLocaleDateString("it-IT", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};

// Get related posts (same tags, excluding current)
const allPosts = await getCollection("blog");
const relatedPosts = allPosts
    .filter((p) => p.slug !== post.slug)
    .filter((p) => p.data.tags.some((tag) => post.data.tags.includes(tag)))
    .slice(0, 2);
---

<Layout
    title={`${post.data.title} - Blog Delizia Alessandro`}
    description={post.data.description}
>
    <Header />

    <main class="pt-24 pb-20">
        <article class="container mx-auto px-4">
            <!-- Breadcrumb -->
            <nav class="mb-8">
                <ol
                    class="flex items-center gap-2 text-sm text-muted-foreground"
                >
                    <li>
                        <a href="/" class="hover:text-primary transition-colors"
                            >Home</a
                        >
                    </li>
                    <li>/</li>
                    <li>
                        <a
                            href="/blog"
                            class="hover:text-primary transition-colors">Blog</a
                        >
                    </li>
                    <li>/</li>
                    <li
                        class="text-foreground font-medium truncate max-w-[200px]"
                    >
                        {post.data.title}
                    </li>
                </ol>
            </nav>

            <div class="flex flex-col lg:flex-row gap-12 relative">
                <!-- Main Content Column -->
                <div class="flex-1 min-w-0">
                    <!-- Article Header -->
                    <header class="mb-12">
                        <div class="flex flex-wrap gap-2 mb-6">
                            {
                                post.data.tags.map((tag) => (
                                    <Badge variant="secondary">{tag}</Badge>
                                ))
                            }
                        </div>
                        <h1
                            class="text-3xl sm:text-4xl lg:text-5xl font-bold text-foreground mb-6 leading-tight"
                        >
                            {post.data.title}
                        </h1>
                        <p class="text-lg text-muted-foreground mb-8">
                            {post.data.description}
                        </p>
                        <div
                            class="flex items-center gap-4 text-sm text-muted-foreground"
                        >
                            <span>{post.data.author}</span>
                            <span>â€¢</span>
                            <time datetime={post.data.pubDate.toISOString()}>
                                {formatDate(post.data.pubDate)}
                            </time>
                        </div>
                    </header>

                    <Separator className="mb-12" />

                    <!-- Article Content -->
                    <div class="article-content max-w-none">
                        <Content />
                    </div>

                    <Separator className="my-12" />

                    <!-- Author / CTA -->
                    <div class="bg-muted/50 rounded-2xl p-8 text-center">
                        <div
                            class="inline-block mx-auto mb-6 p-4 rounded-xl bg-white shadow-sm border border-border/50"
                        >
                            <Image
                                src="/images/logo-deliziaalessandro.svg"
                                alt="Delizia Alessandro Logo"
                                width={128}
                                height={128}
                                class="h-20 w-auto object-contain"
                            />
                        </div>
                        <h3 class="font-bold text-xl text-foreground mb-2">
                            Delizia Alessandro S.r.l.
                        </h3>
                        <p class="text-muted-foreground mb-6 max-w-md mx-auto">
                            Da oltre 70 anni, il tuo partner di fiducia per
                            materiali edili e arredobagno ad Amantea.
                        </p>
                        <div
                            class="flex flex-col sm:flex-row items-center justify-center gap-4"
                        >
                            <a
                                href="/#contatti"
                                class={cn(buttonVariants({ size: "default" }))}
                            >
                                Richiedi Informazioni
                            </a>
                            <a
                                href="/#showroom"
                                class={cn(
                                    buttonVariants({ variant: "outline" }),
                                )}
                            >
                                Visita lo Showroom
                            </a>
                        </div>
                    </div>

                    <!-- Related Posts -->
                    {
                        relatedPosts.length > 0 && (
                            <div class="mt-16">
                                <h3 class="text-xl font-bold text-foreground mb-6">
                                    Articoli Correlati
                                </h3>
                                <div class="grid sm:grid-cols-2 gap-6">
                                    {relatedPosts.map((related) => (
                                        <a
                                            href={`/blog/${related.slug}`}
                                            class="group p-6 rounded-xl border border-border/50 hover:border-primary/30 hover:shadow-lg transition-all"
                                        >
                                            <div class="flex flex-wrap gap-2 mb-3">
                                                {related.data.tags
                                                    .slice(0, 2)
                                                    .map((tag) => (
                                                        <Badge
                                                            variant="secondary"
                                                            className="text-xs"
                                                        >
                                                            {tag}
                                                        </Badge>
                                                    ))}
                                            </div>
                                            <h4 class="font-bold text-foreground group-hover:text-primary transition-colors line-clamp-2 mb-2">
                                                {related.data.title}
                                            </h4>
                                            <p class="text-sm text-muted-foreground line-clamp-2">
                                                {related.data.description}
                                            </p>
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )
                    }

                    <!-- Back to Blog and Navigation -->
                    <div class="mt-12 pt-8 border-t border-border/50">
                        <div
                            class="flex flex-col sm:flex-row justify-between items-center gap-4"
                        >
                            {
                                prevPost ? (
                                    <a
                                        href={`/blog/${prevPost.slug}`}
                                        class="group flex items-center gap-3 text-muted-foreground hover:text-primary transition-colors text-sm font-medium"
                                    >
                                        <div class="p-2 rounded-full border border-border/50 bg-background group-hover:border-primary/50 transition-colors">
                                            <svg
                                                class="w-4 h-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M15 19l-7-7 7-7"
                                                />
                                            </svg>
                                        </div>
                                        <div class="text-left">
                                            <span class="block text-xs text-muted-foreground/70">
                                                Precedente
                                            </span>
                                            <span class="block text-foreground group-hover:text-primary transition-colors line-clamp-1 max-w-[150px] sm:max-w-[200px]">
                                                {prevPost.data.title}
                                            </span>
                                        </div>
                                    </a>
                                ) : (
                                    <div />
                                )
                            }

                            <a
                                href="/blog"
                                class="text-primary font-medium hover:underline text-sm"
                            >
                                Torna al Blog
                            </a>

                            {
                                nextPost ? (
                                    <a
                                        href={`/blog/${nextPost.slug}`}
                                        class="group flex items-center gap-3 text-muted-foreground hover:text-primary transition-colors text-sm font-medium text-right"
                                    >
                                        <div class="text-right">
                                            <span class="block text-xs text-muted-foreground/70">
                                                Successivo
                                            </span>
                                            <span class="block text-foreground group-hover:text-primary transition-colors line-clamp-1 max-w-[150px] sm:max-w-[200px]">
                                                {nextPost.data.title}
                                            </span>
                                        </div>
                                        <div class="p-2 rounded-full border border-border/50 bg-background group-hover:border-primary/50 transition-colors">
                                            <svg
                                                class="w-4 h-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M9 5l7 7-7 7"
                                                />
                                            </svg>
                                        </div>
                                    </a>
                                ) : (
                                    <div />
                                )
                            }
                        </div>
                    </div>
                </div>

                <!-- Sidebar TOC -->
                <aside class="hidden lg:block w-80 flex-shrink-0">
                    <div class="sticky top-32">
                        {
                            headings.length > 0 && (
                                <div class="mb-8">
                                    <h4 class="font-semibold mb-4 text-sm uppercase tracking-wider text-muted-foreground">
                                        Indice
                                    </h4>
                                    <nav class="flex flex-col gap-2 border-l border-border/50">
                                        {headings.map((heading) => (
                                            <a
                                                href={`#${heading.slug}`}
                                                class={`text-sm py-1 pl-4 border-l -ml-px transition-colors hover:text-primary ${
                                                    heading.depth === 2
                                                        ? "text-foreground font-medium border-transparent"
                                                        : "text-muted-foreground border-transparent pl-8"
                                                }`}
                                            >
                                                {heading.text}
                                            </a>
                                        ))}
                                    </nav>
                                </div>
                            )
                        }

                        <!-- Sidebar CTA -->
                        <div
                            class="p-6 bg-muted/30 rounded-xl border border-border/50"
                        >
                            <h4 class="font-bold text-foreground mb-2">
                                Hai bisogno di consigli?
                            </h4>
                            <p class="text-sm text-muted-foreground mb-4">
                                I nostri esperti sono a tua disposizione per
                                guidarti nella scelta dei materiali migliori.
                            </p>
                            <a
                                href="/#contatti"
                                class={cn(
                                    buttonVariants({
                                        size: "sm",
                                        variant: "default",
                                    }),
                                    "w-full mb-2",
                                )}
                            >
                                Contattaci
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </article>
    </main>

    <Footer />
</Layout>

<style is:global>
    .article-content h1 {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--foreground);
        margin-top: 2rem;
        margin-bottom: 1rem;
        line-height: 1.2;
    }
    .article-content h2 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--foreground);
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        line-height: 1.3;
    }
    .article-content h3 {
        font-size: 1.375rem;
        font-weight: 600;
        color: var(--foreground);
        margin-top: 2rem;
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }
    .article-content p {
        font-size: 1.125rem;
        color: var(--muted-foreground);
        margin-bottom: 1.25rem;
        line-height: 1.75;
    }
    .article-content ul,
    .article-content ol {
        margin: 1.25rem 0;
        padding-left: 1.5rem;
    }
    .article-content li {
        font-size: 1.125rem;
        color: var(--muted-foreground);
        margin-bottom: 0.5rem;
        line-height: 1.75;
    }
    .article-content ul li {
        list-style-type: disc;
    }
    .article-content ol li {
        list-style-type: decimal;
    }
    .article-content strong {
        font-weight: 600;
        color: var(--foreground);
    }
    .article-content a {
        color: var(--primary);
        text-decoration: underline;
    }
    .article-content a:hover {
        opacity: 0.8;
    }
    .article-content hr {
        margin: 2rem 0;
        border-color: var(--border);
    }
</style>
