---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { Button, buttonVariants } from "../../components/ui/button";
import CTASection from "../../components/CTASection.astro";
import { cn } from "@/lib/utils";
import { Image } from "astro:assets";

export async function getStaticPaths() {
    const brands = await getCollection("brands");
    brands.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

    return brands.map((brand, index) => ({
        params: { slug: brand.slug },
        props: {
            brand,
            prevBrand: index > 0 ? brands[index - 1] : null,
            nextBrand: index < brands.length - 1 ? brands[index + 1] : null,
        },
    }));
}

const { brand } = Astro.props;
const { prevBrand, nextBrand } = Astro.props;
const { Content } = await brand.render();

// For brand pages without TOC headings, we might want to manually create some or just skip the TOC
// brands usually have shorter content, but we'll keep the layout structure for consistency.
// Map category names to slugs
const allCategories = await getCollection("categories");
const categorySlugMap = new Map(
    allCategories.map((c) => [c.data.name, c.slug]),
);
---

<Layout
    title={`${brand.data.name} - Delizia Alessandro S.r.l.`}
    description={brand.data.description}
>
    <Header />
    <main class="min-h-screen bg-background">
        <!-- Hero Section -->
        <section class="pt-32 pb-16 lg:pt-40 lg:pb-20 bg-muted/10">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl">
                    <a
                        href="/marchi"
                        class="inline-flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-primary transition-colors mb-8 bg-background/80 backdrop-blur-sm px-4 py-2 border border-border/50"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Tutti i marchi
                    </a>

                    <div class="flex flex-col md:flex-row gap-8 items-start">
                        {
                            brand.data.logo && (
                                <div class="w-48 h-48 shrink-0 bg-white flex items-center justify-center p-8 border border-border/50">
                                    <Image
                                        src={brand.data.logo}
                                        alt={`Logo ${brand.data.name}`}
                                        width={192}
                                        height={192}
                                        class="max-w-full max-h-full object-contain"
                                    />
                                </div>
                            )
                        }

                        <div class="flex-1">
                            <h1
                                class="text-4xl sm:text-5xl font-bold text-foreground mb-4"
                            >
                                {brand.data.name}
                            </h1>

                            {/* Category Tags */}
                            {
                                brand.data.categories &&
                                    brand.data.categories.length > 0 && (
                                        <div class="flex flex-wrap gap-3 mb-6">
                                            {brand.data.categories.map(
                                                (catName: string) => {
                                                    const slug =
                                                        categorySlugMap.get(catName);
                                                    if (!slug) return null;
                                                    return (
                                                        <a
                                                            href={`/categorie/${slug}`}
                                                            class="text-sm font-medium text-primary hover:text-primary/80 transition-colors underline decoration-primary/30 hover:decoration-primary underline-offset-4"
                                                        >
                                                            {catName}
                                                        </a>
                                                    );
                                                },
                                            )}
                                        </div>
                                    )
                            }

                            <p
                                class="text-lg text-muted-foreground leading-relaxed mb-6"
                            >
                                {brand.data.description}
                            </p>

                            <a
                                href={brand.data.website}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-primary-foreground font-medium hover:bg-primary/90 transition-colors"
                            >
                                Visita il sito ufficiale
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                                    ></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-12 lg:py-20">
            <div class="container mx-auto px-4">
                <div class="flex flex-col lg:flex-row gap-12 max-w-6xl mx-auto">
                    <!-- Content -->
                    <article class="flex-1 min-w-0">
                        <div
                            class="prose prose-sm prose-slate dark:prose-invert max-w-none
                            prose-headings:scroll-mt-32
                            prose-h2:text-3xl prose-h2:font-bold prose-h2:tracking-tight prose-h2:mt-12 prose-h2:mb-6
                            prose-h3:text-2xl prose-h3:font-semibold prose-h3:mt-8 prose-h3:mb-4
                            prose-p:leading-relaxed prose-p:text-muted-foreground
                            prose-li:text-muted-foreground
                            prose-strong:text-foreground prose-strong:font-semibold
                            prose-img:rounded-xl prose-img:shadow-lg"
                        >
                            <Content />
                        </div>
                    </article>

                    <!-- Sidebar / Info (optional for Brands if we don't have enough content for TOC) -->
                    <!-- keeping it simple for brands often centered content is better if text is short -->
                </div>
            </div>
        </section>

        <!-- Images Gallery -->
        {
            brand.data.images && brand.data.images.length > 0 && (
                <section class="py-16 lg:py-24 bg-muted/10">
                    <div class="container mx-auto px-4">
                        <h2 class="text-3xl font-bold text-foreground mb-12">
                            Galleria Fotografica
                        </h2>
                        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 max-w-6xl">
                            {brand.data.images.map(
                                (image: string, index: number) => (
                                    <div
                                        class="group aspect-video overflow-hidden bg-background border border-border/50 hover:border-primary transition-colors cursor-pointer lightbox-trigger"
                                        data-src={image}
                                    >
                                        <div class="w-full h-full overflow-hidden">
                                            <Image
                                                src={image}
                                                alt={`${brand.data.name} - Immagine ${index + 1}`}
                                                width={1280}
                                                height={720}
                                                class="w-full h-full object-cover"
                                            />
                                        </div>
                                    </div>
                                ),
                            )}
                        </div>
                    </div>
                </section>
            )
        }

        <!-- Lightbox Modal -->
        <div
            id="lightbox"
            class="fixed inset-0 z-50 hidden bg-black/95 transition-opacity duration-300 opacity-0"
        >
            <div class="absolute top-4 right-4 z-50">
                <button
                    id="lightbox-close"
                    class="w-12 h-12 bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition-colors"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="w-full h-full flex items-center justify-center p-4">
                <img
                    id="lightbox-image"
                    src=""
                    alt="Full screen preview"
                    class="max-w-full max-h-full object-contain"
                />
            </div>
        </div>

        <script>
            const lightbox = document.getElementById("lightbox");
            const lightboxImage = document.getElementById(
                "lightbox-image",
            ) as HTMLImageElement;
            const closeBtn = document.getElementById("lightbox-close");
            const triggers = document.querySelectorAll(".lightbox-trigger");

            function openLightbox(src: string) {
                if (lightbox && lightboxImage) {
                    lightboxImage.src = src;
                    lightbox.classList.remove("hidden");
                    // Small timeout to allow display:block to apply before opacity transition
                    setTimeout(() => {
                        lightbox.classList.remove("opacity-0");
                    }, 10);
                    document.body.style.overflow = "hidden"; // Prevent scrolling
                }
            }

            function closeLightbox() {
                if (lightbox) {
                    lightbox.classList.add("opacity-0");
                    setTimeout(() => {
                        lightbox.classList.add("hidden");
                        if (lightboxImage) lightboxImage.src = "";
                    }, 300); // Match transition duration
                    document.body.style.overflow = "";
                }
            }

            triggers.forEach((trigger) => {
                trigger.addEventListener("click", () => {
                    const src = trigger.getAttribute("data-src");
                    if (src) openLightbox(src);
                });
            });

            closeBtn?.addEventListener("click", closeLightbox);

            // Close on click outside image
            lightbox?.addEventListener("click", (e) => {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });

            // Close on Escape key
            document.addEventListener("keydown", (e) => {
                if (
                    e.key === "Escape" &&
                    lightbox &&
                    !lightbox.classList.contains("hidden")
                ) {
                    closeLightbox();
                }
            });
        </script>
    </main>
</Layout>

<!-- Previous/Next Brand Navigation -->
<section class="py-8 border-t border-border/50">
    <div class="container mx-auto px-4">
        <div
            class="flex flex-col sm:flex-row justify-between items-center gap-4 max-w-6xl mx-auto"
        >
            {
                prevBrand ? (
                    <a
                        href={`/marchi/${prevBrand.slug}`}
                        class="group flex items-center gap-3 text-muted-foreground hover:text-primary transition-colors text-sm font-medium"
                    >
                        <div class="p-2 rounded-full border border-border/50 bg-background group-hover:border-primary/50 transition-colors">
                            <svg
                                class="w-4 h-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 19l-7-7 7-7"
                                />
                            </svg>
                        </div>
                        <div class="text-left">
                            <span class="block text-xs text-muted-foreground/70">
                                Precedente
                            </span>
                            <span class="block text-foreground group-hover:text-primary transition-colors">
                                {prevBrand.data.name}
                            </span>
                        </div>
                    </a>
                ) : (
                    <div />
                )
            }

            <a
                href="/marchi"
                class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors flex items-center gap-2"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
                Tutti i marchi
            </a>

            {
                nextBrand ? (
                    <a
                        href={`/marchi/${nextBrand.slug}`}
                        class="group flex items-center gap-3 text-muted-foreground hover:text-primary transition-colors text-sm font-medium text-right"
                    >
                        <div class="text-right">
                            <span class="block text-xs text-muted-foreground/70">
                                Successivo
                            </span>
                            <span class="block text-foreground group-hover:text-primary transition-colors">
                                {nextBrand.data.name}
                            </span>
                        </div>
                        <div class="p-2 rounded-full border border-border/50 bg-background group-hover:border-primary/50 transition-colors">
                            <svg
                                class="w-4 h-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5l7 7-7 7"
                                />
                            </svg>
                        </div>
                    </a>
                ) : (
                    <div />
                )
            }
        </div>
    </div>
</section>

<!-- CTA Section -->
<CTASection
    title={`Interessato a ${brand.data.name}?`}
    description="Vieni a trovarci nel nostro showroom per scoprire l'intera gamma e vedere i campioni dal vivo."
    primaryText="Richiedi informazioni"
    secondaryText="Dove siamo"
/>

<Footer />
