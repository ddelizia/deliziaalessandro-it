---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getCollection } from "astro:content";
import BrandCard from "../../components/BrandCard.astro";
import { buttonVariants } from "../../components/ui/button";
import { cn } from "@/lib/utils";

const brands = (await getCollection("brands")).sort(
  (a, b) => a.data.order - b.data.order,
);

// Extract unique categories
const allCategories = [
  ...new Set(brands.flatMap((brand) => brand.data.categories || [])),
].sort();

const title = "I Nostri Marchi - Delizia Alessandro S.r.l.";
const description =
  "Scopri tutti i marchi partner di Delizia Alessandro S.r.l. Qualit√† e design per l'edilizia e l'arredo bagno. Visualizza il catalogo completo.";
---

<Layout title={title} description={description}>
  <Header />
  <main class="min-h-screen bg-background pt-32 pb-20">
    <div class="container mx-auto px-4">
      <!-- Page Header -->
      <div class="text-center mb-12">
        <h1
          class="text-4xl sm:text-5xl lg:text-6xl font-bold text-foreground mb-6"
        >
          I Nostri Marchi
        </h1>
        <p class="text-xl text-muted-foreground max-w-3xl mx-auto">
          Collaboriamo con le migliori aziende italiane ed internazionali per
          garantire l'eccellenza nei materiali e nelle finiture per la tua casa.
        </p>
      </div>

      <!-- Filter Section Desktop -->
      <div class="hidden lg:flex flex-wrap gap-2 mb-12">
        <button
          data-category="all"
          class={cn(
            buttonVariants({ variant: "default" }),
            "filter-btn px-6",
          )}
        >
          Tutti
        </button>
        {
          allCategories.map((category) => (
            <button
              data-category={category}
              class={cn(
                buttonVariants({ variant: "outline" }),
                "filter-btn px-6",
              )}
            >
              {category}
            </button>
          ))
        }
      </div>

      <!-- Filter Section Mobile (Collapsible) -->
      <div class="lg:hidden mb-8">
        <button
          id="mobile-filter-toggle"
          class="w-full flex items-center justify-between p-4 bg-muted/50 border border-border/50 text-left font-medium text-sm hover:bg-muted transition-colors"
        >
          <span class="flex items-center gap-2">
            <svg
              class="w-5 h-5 text-muted-foreground"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
              />
            </svg>
            <span>Filtra per categoria</span>
            <span id="active-category-label" class="text-primary font-semibold">
              (Tutti)
            </span>
          </span>
          <svg
            id="mobile-filter-icon"
            class="w-5 h-5 transition-transform"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>
        <div
          id="mobile-filter-content"
          class="hidden border-x border-b border-border/50 bg-background"
        >
          <div class="flex flex-col p-4 gap-2">
            <button
              data-category="all"
              class={cn(
                buttonVariants({ variant: "default" }),
                "filter-btn mobile-filter-btn w-full justify-start",
              )}
            >
              Tutti i marchi
            </button>
            {
              allCategories.map((category) => (
                <button
                  data-category={category}
                  class={cn(
                    buttonVariants({ variant: "outline" }),
                    "filter-btn mobile-filter-btn w-full justify-start",
                  )}
                >
                  {category}
                </button>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Brands Grid -->
      <div
        id="brands-grid"
        class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
      >
        {brands.map((brand) => <BrandCard brand={brand} />)}
      </div>

      <!-- No Results Message -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-xl text-muted-foreground">
          Nessun marchio trovato per questa categoria.
        </p>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    initFilter();
    initMobileFilterToggle();
  });

  // Also run on initial load if view transitions are not used or for first render
  initFilter();
  initMobileFilterToggle();

  function initMobileFilterToggle() {
    const mobileToggle = document.getElementById("mobile-filter-toggle");
    const mobileContent = document.getElementById("mobile-filter-content");
    const mobileIcon = document.getElementById("mobile-filter-icon");

    if (mobileToggle && mobileContent && mobileIcon) {
      mobileToggle.addEventListener("click", () => {
        const isHidden = mobileContent.classList.contains("hidden");

        if (isHidden) {
          mobileContent.classList.remove("hidden");
          mobileIcon.style.transform = "rotate(180deg)";
        } else {
          mobileContent.classList.add("hidden");
          mobileIcon.style.transform = "rotate(0deg)";
        }
      });
    }
  }

  function initFilter() {
    const filterBtns = document.querySelectorAll(".filter-btn");
    const brandItems = document.querySelectorAll(
      ".brand-item",
    ) as NodeListOf<HTMLElement>;
    const noResults = document.getElementById("no-results");
    const mobileContent = document.getElementById("mobile-filter-content");
    const mobileIcon = document.getElementById("mobile-filter-icon");
    const activeCategoryLabel = document.getElementById("active-category-label");

    filterBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        // Remove active class from all buttons
        filterBtns.forEach((b) => {
          b.classList.remove(
            "bg-primary",
            "text-primary-foreground",
            "hover:bg-primary/90",
          );
          b.classList.add(
            "bg-background",
            //"text-accent-foreground", // Removed problematic class
            "text-foreground", // Added reset to default text color
            "border",
            "border-input",
            "hover:bg-accent",
            "hover:text-accent-foreground",
          );
        });

        // Add active class to clicked button
        btn.classList.remove(
          "bg-background",
          "text-accent-foreground",
          "border",
          "border-input",
          "hover:bg-accent",
          "hover:text-accent-foreground",
        );
        btn.classList.add(
          "bg-primary",
          "text-primary-foreground",
          "hover:bg-primary/90",
        );

        const selectedCategory = btn.getAttribute("data-category");
        const categoryText = btn.textContent?.trim() || "Tutti";
        let visibleCount = 0;

        // Update mobile active category label
        if (activeCategoryLabel) {
          activeCategoryLabel.textContent = `(${categoryText})`;
        }

        // Close mobile filter after selection
        if (btn.classList.contains("mobile-filter-btn") && mobileContent && mobileIcon) {
          mobileContent.classList.add("hidden");
          mobileIcon.style.transform = "rotate(0deg)";
        }

        brandItems.forEach((item) => {
          const itemCategories =
            item.getAttribute("data-categories")?.split(",") || [];

          if (
            selectedCategory === "all" ||
            itemCategories.includes(selectedCategory!)
          ) {
            item.classList.remove("hidden");
            // Add a small animation/fade-in class if desired
            item.animate(
              [
                { opacity: 0, transform: "scale(0.95)" },
                { opacity: 1, transform: "scale(1)" },
              ],
              {
                duration: 300,
                easing: "ease-out",
              },
            );
            visibleCount++;
          } else {
            item.classList.add("hidden");
          }
        });

        // Show/Hide "No Results" message
        if (visibleCount === 0 && noResults) {
          noResults.classList.remove("hidden");
        } else if (noResults) {
          noResults.classList.add("hidden");
        }
      });
    });
  }
</script>
