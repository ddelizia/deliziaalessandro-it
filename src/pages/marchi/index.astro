---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getCollection } from "astro:content";
import BrandCard from "../../components/BrandCard.astro";
import { buttonVariants } from "../../components/ui/button";
import { cn } from "@/lib/utils";

const brands = (await getCollection("brands")).sort(
  (a, b) => a.data.order - b.data.order,
);

// Extract unique categories
const allCategories = [
  ...new Set(brands.flatMap((brand) => brand.data.categories || [])),
].sort();

const title = "I Nostri Marchi - Delizia Alessandro S.r.l.";
const description =
  "Scopri tutti i marchi partner di Delizia Alessandro S.r.l. Qualit√† e design per l'edilizia e l'arredo bagno. Visualizza il catalogo completo.";
---

<Layout title={title} description={description}>
  <Header />
  <main class="min-h-screen bg-background pt-32 pb-20">
    <div class="container mx-auto px-4">
      <!-- Page Header -->
      <div class="text-center mb-12">
        <h1
          class="text-4xl sm:text-5xl lg:text-6xl font-bold text-foreground mb-6"
        >
          I Nostri Marchi
        </h1>
        <p class="text-xl text-muted-foreground max-w-3xl mx-auto">
          Collaboriamo con le migliori aziende italiane ed internazionali per
          garantire l'eccellenza nei materiali e nelle finiture per la tua casa.
        </p>
      </div>

      <!-- Filter Section -->
      <div class="flex flex-wrap justify-center gap-2 mb-12">
        <button
          data-category="all"
          class={cn(
            buttonVariants({ variant: "default" }),
            "filter-btn rounded-full px-6",
          )}
        >
          Tutti
        </button>
        {
          allCategories.map((category) => (
            <button
              data-category={category}
              class={cn(
                buttonVariants({ variant: "outline" }),
                "filter-btn rounded-full px-6",
              )}
            >
              {category}
            </button>
          ))
        }
      </div>

      <!-- Brands Grid -->
      <div
        id="brands-grid"
        class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
      >
        {brands.map((brand) => <BrandCard brand={brand} />)}
      </div>

      <!-- No Results Message -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-xl text-muted-foreground">
          Nessun marchio trovato per questa categoria.
        </p>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    initFilter();
  });

  // Also run on initial load if view transitions are not used or for first render
  initFilter();

  function initFilter() {
    const filterBtns = document.querySelectorAll(".filter-btn");
    const brandItems = document.querySelectorAll(
      ".brand-item",
    ) as NodeListOf<HTMLElement>;
    const noResults = document.getElementById("no-results");

    filterBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        // Remove active class from all buttons
        filterBtns.forEach((b) => {
          b.classList.remove(
            "bg-primary",
            "text-primary-foreground",
            "hover:bg-primary/90",
          );
          b.classList.add(
            "bg-background",
            //"text-accent-foreground", // Removed problematic class
            "text-foreground", // Added reset to default text color
            "border",
            "border-input",
            "hover:bg-accent",
            "hover:text-accent-foreground",
          );
        });

        // Add active class to clicked button
        btn.classList.remove(
          "bg-background",
          "text-accent-foreground",
          "border",
          "border-input",
          "hover:bg-accent",
          "hover:text-accent-foreground",
        );
        btn.classList.add(
          "bg-primary",
          "text-primary-foreground",
          "hover:bg-primary/90",
        );

        const selectedCategory = btn.getAttribute("data-category");
        let visibleCount = 0;

        brandItems.forEach((item) => {
          const itemCategories =
            item.getAttribute("data-categories")?.split(",") || [];

          if (
            selectedCategory === "all" ||
            itemCategories.includes(selectedCategory!)
          ) {
            item.classList.remove("hidden");
            // Add a small animation/fade-in class if desired
            item.animate(
              [
                { opacity: 0, transform: "scale(0.95)" },
                { opacity: 1, transform: "scale(1)" },
              ],
              {
                duration: 300,
                easing: "ease-out",
              },
            );
            visibleCount++;
          } else {
            item.classList.add("hidden");
          }
        });

        // Show/Hide "No Results" message
        if (visibleCount === 0 && noResults) {
          noResults.classList.remove("hidden");
        } else if (noResults) {
          noResults.classList.add("hidden");
        }
      });
    });
  }
</script>
